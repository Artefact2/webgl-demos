<!DOCTYPE html>
<html>
<head>
<title>Platonic Solids</title>
<meta charset='utf-8' />
<link type='text/css' href='./skel.css' rel='stylesheet' />
<script type='application/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js'></script>
<script type='application/javascript' src='https://cdn.jsdelivr.net/glmatrix/2.2.0/gl-matrix.js'></script>
<script type='application/javascript' src='./mousetrap.min.js'></script>
<script type='application/javascript' src='./glsoup.js'></script>
<script type='application/javascript'>
$(function() {
	var canvas = document.createElement('canvas');
	var body = $('body');
	body.append(canvas);

	var gl = create_context(canvas);
	if(gl === false) return;

	gl.enable(gl.BLEND);
	gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);

	gl.enable(gl.CULL_FACE);
	gl.cullFace(gl.BACK);

	var prog = create_program_vf(gl, $("pre#vs").text(), $("pre#fs").text())[0];
	gl.useProgram(prog);

	var aposition = gl.getAttribLocation(prog, "position");
	var anormal = gl.getAttribLocation(prog, "normal");
	gl.enableVertexAttribArray(aposition);
	gl.enableVertexAttribArray(anormal);

	var umodelmat = gl.getUniformLocation(prog, "modelmat");
	var upmat = gl.getUniformLocation(prog, "pmat");
	var unormalmat = gl.getUniformLocation(prog, "normalmat");
	var ut = gl.getUniformLocation(prog, "t");
	var ulpos = gl.getUniformLocation(prog, "lpos");
	var uw = gl.getUniformLocation(prog, "w");

	primitive_tetrahedron = function() {
		var vb = gl.createBuffer();
		var ve = gl.createBuffer();
		var ne = 12;
		
		gl.bindBuffer(gl.ARRAY_BUFFER, vb);
		gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(normalize_faces([
			/* ACB */
			-0.5, 0.5, 0.5,
			0.5, -0.5, 0.5,
			0.5, 0.5, -0.5,
			/* ABD */
			-0.5, 0.5, 0.5,
			0.5, 0.5, -0.5,
			-0.5, -0.5, -0.5,
			/* ADC */
			-0.5, 0.5, 0.5,
			-0.5, -0.5, -0.5,
			0.5, -0.5, 0.5,
			/* BCD */
			0.5, 0.5, -0.5,
			0.5, -0.5, 0.5,
			-0.5, -0.5, -0.5,
		])), gl.STATIC_DRAW);

		gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ve);
		gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Uint8Array([
			0, 1, 2,
			3, 4, 5,
			6, 7, 8,
			9, 10, 11
		]), gl.STATIC_DRAW);

		return [ vb, ve, ne ];
	};

	primitive_cube = function() {
		var vb = gl.createBuffer();
		var ve = gl.createBuffer();
		var ne = 36;
		
		gl.bindBuffer(gl.ARRAY_BUFFER, vb);
		gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
			/* ABFE */
			-0.5, -0.5, 0.5,  0.0, 0.0, 1.0,  1.0, 0.0, 0.0,
			0.5, -0.5, 0.5,   0.0, 0.0, 1.0,  0.0, 1.0, 0.0,
			0.5, 0.5, 0.5,    0.0, 0.0, 1.0,  0.0, 0.0, 1.0,
			-0.5, 0.5, 0.5,   0.0, 0.0, 1.0,  0.0, 1.0, 0.0,
			/* BCGF */
			0.5, -0.5, 0.5,   1.0, 0.0, 0.0,  1.0, 0.0, 0.0,
			0.5, -0.5, -0.5,  1.0, 0.0, 0.0,  0.0, 1.0, 0.0,
			0.5, 0.5, -0.5,   1.0, 0.0, 0.0,  0.0, 0.0, 1.0,
			0.5, 0.5, 0.5,    1.0, 0.0, 0.0,  0.0, 1.0, 0.0,
			/* CDHG */
			0.5, -0.5, -0.5,  0.0, 0.0, -1.0, 1.0, 0.0, 0.0,
			-0.5, -0.5, -0.5, 0.0, 0.0, -1.0, 0.0, 1.0, 0.0,
			-0.5, 0.5, -0.5,  0.0, 0.0, -1.0, 0.0, 0.0, 1.0,
			0.5, 0.5, -0.5,   0.0, 0.0, -1.0, 0.0, 1.0, 0.0,
			/* DAEH */
			-0.5, -0.5, -0.5, -1.0, 0.0, 0.0, 1.0, 0.0, 0.0,
			-0.5, -0.5, 0.5,  -1.0, 0.0, 0.0, 0.0, 1.0, 0.0,
			-0.5, 0.5, 0.5,   -1.0, 0.0, 0.0, 0.0, 0.0, 1.0,
			-0.5, 0.5, -0.5,  -1.0, 0.0, 0.0, 0.0, 1.0, 0.0,
			/* EFGH */
			-0.5, 0.5, 0.5,   0.0, 1.0, 0.0, 1.0, 0.0, 0.0,
			0.5, 0.5, 0.5,    0.0, 1.0, 0.0, 0.0, 1.0, 0.0,
			0.5, 0.5, -0.5,   0.0, 1.0, 0.0, 0.0, 0.0, 1.0,
			-0.5, 0.5, -0.5,  0.0, 1.0, 0.0, 0.0, 1.0, 0.0,
			/* DCBA */
			-0.5, -0.5, -0.5, 0.0, -1.0, 0.0, 1.0, 0.0, 0.0,
			0.5, -0.5, -0.5,  0.0, -1.0, 0.0, 0.0, 1.0, 0.0,
			0.5, -0.5, 0.5,   0.0, -1.0, 0.0, 0.0, 0.0, 1.0,
			-0.5, -0.5, 0.5,  0.0, -1.0, 0.0, 0.0, 1.0, 0.0,
		]), gl.STATIC_DRAW);

		gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ve);
		gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Uint8Array([
			0, 1, 2,
			0, 2, 3,
			4, 5, 6,
			4, 6, 7,
			8, 9, 10,
			8, 10, 11,
			12, 13, 14,
			12, 14, 15,
			16, 17, 18,
			16, 18, 19,
			20, 21, 22,
			20, 22, 23,
		]), gl.STATIC_DRAW);

		return [ vb, ve, ne ];
	};
	
	primitive_octahedron = function() {
		var vb = gl.createBuffer();
		var ve = gl.createBuffer();
		var ne = 24;
		
		gl.bindBuffer(gl.ARRAY_BUFFER, vb);
		gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
			/* ABE */
			-0.5, 0.0, 0.0,    -1.0, -1.0, 1.0,    1.0, 0.0, 0.0,
			0.0, -0.5, 0.0,    -1.0, -1.0, 1.0,    0.0, 1.0, 0.0,
			0.0, 0.0, 0.5,     -1.0, -1.0, 1.0,    0.0, 0.0, 1.0,
			/* BCE */
			0.0, -0.5, 0.0,    1.0, -1.0, 1.0,     1.0, 0.0, 0.0,
			0.5, 0.0, 0.0,     1.0, -1.0, 1.0,     0.0, 1.0, 0.0,
			0.0, 0.0, 0.5,     1.0, -1.0, 1.0,     0.0, 0.0, 1.0,
			/* CDE */
			0.5, 0.0, 0.0,     1.0, 1.0, 1.0,      1.0, 0.0, 0.0,
			0.0, 0.5, 0.0,     1.0, 1.0, 1.0,      0.0, 1.0, 0.0,
			0.0, 0.0, 0.5,     1.0, 1.0, 1.0,      0.0, 0.0, 1.0,
			/* DAE */
			0.0, 0.5, 0.0,     -1.0, 1.0, 1.0,     1.0, 0.0, 0.0,
			-0.5, 0.0, 0.0,    -1.0, 1.0, 1.0,     0.0, 1.0, 0.0,
			0.0, 0.0, 0.5,     -1.0, 1.0, 1.0,     0.0, 0.0, 1.0,
			/* ABF */
			-0.5, 0.0, 0.0,    -1.0, -1.0, -1.0,   1.0, 0.0, 0.0,
			0.0, -0.5, 0.0,    -1.0, -1.0, -1.0,   0.0, 1.0, 0.0,
			0.0, 0.0, -0.5,    -1.0, -1.0, -1.0,   0.0, 0.0, 1.0,
			/* BCF */
			0.0, -0.5, 0.0,    1.0, -1.0, -1.0,    1.0, 0.0, 0.0,
			0.5, 0.0, 0.0,     1.0, -1.0, -1.0,    0.0, 1.0, 0.0,
			0.0, 0.0, -0.5,    1.0, -1.0, -1.0,    0.0, 0.0, 1.0,
			/* CDF */
			0.5, 0.0, 0.0,     1.0, 1.0, -1.0,     0.0, 1.0, 0.0,
			0.0, 0.5, 0.0,     1.0, 1.0, -1.0,     1.0, 0.0, 0.0,
			0.0, 0.0, -0.5,    1.0, 1.0, -1.0,     0.0, 0.0, 1.0,
			/* DAF */
			0.0, 0.5, 0.0,     -1.0, 1.0, -1.0,    1.0, 0.0, 0.0,
			-0.5, 0.0, 0.0,    -1.0, 1.0, -1.0,    0.0, 1.0, 0.0,
			0.0, 0.0, -0.5,    -1.0, 1.0, -1.0,    0.0, 0.0, 1.0,
		]), gl.STATIC_DRAW);

		gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ve);
		gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Uint8Array([
			0, 1, 2,
			3, 4, 5,
			6, 7, 8,
			9, 10, 11,
			12, 14, 13,
			15, 17, 16,
			18, 20, 19,
			21, 23, 22,
		]), gl.STATIC_DRAW);

		return [ vb, ve, ne ];
	};
	
	primitive_icosahedron = function() {
		var vb = gl.createBuffer();
		var ve = gl.createBuffer();
		var ne = 60;

		var phi = (1 + Math.sqrt(3)) / 4;
		
		gl.bindBuffer(gl.ARRAY_BUFFER, vb);
		gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(normalize_faces([
			/* ABE */
			-0.5, 0.0, phi,
			0.5, 0.0, phi,
			0.0, phi, 0.5,
			/* AHB */
			-0.5, 0.0, phi,
			0.0, -phi, 0.5,
			0.5, 0.0, phi,
			/* CDF */
			0.5, 0.0, -phi,
			-0.5, 0.0, -phi,
			0.0, phi, -0.5,
			/* CGD */
			0.5, 0.0, -phi,
			0.0, -phi, -0.5,
			-0.5, 0.0, -phi,
			/* EFL */
			0.0, phi, 0.5,
			0.0, phi, -0.5,
			-phi, 0.5, 0.0,
			/* EIF */
			0.0, phi, 0.5,
			phi, 0.5, 0.0,
			0.0, phi, -0.5,
			/* GHK */
			0.0, -phi, -0.5,
			0.0, -phi, 0.5,
			-phi, -0.5, 0.0,
			/* GJH */
			0.0, -phi, -0.5,
			phi, -0.5, 0.0,
			0.0, -phi, 0.5,
			/* IJC */
			phi, 0.5, 0.0,
			phi, -0.5, 0.0,
			0.5, 0.0, -phi,
			/* IBJ */
			phi, 0.5, 0.0,
			0.5, 0.0, phi,
			phi, -0.5, 0.0,
			/* KLD */
			-phi, -0.5, 0.0,
			-phi, 0.5, 0.0,
			-0.5, 0.0, -phi,
			/* KAL */
			-phi, -0.5, 0.0,
			-0.5, 0.0, phi,
			-phi, 0.5, 0.0,
			/* BIE */
			0.5, 0.0, phi,
			phi, 0.5, 0.0,
			0.0, phi, 0.5,
			/* AEL */
			-0.5, 0.0, phi,
			0.0, phi, 0.5,
			-phi, 0.5, 0.0,
			/* CFI */
			0.5, 0.0, -phi,
			0.0, phi, -0.5,
			phi, 0.5, 0.0,
			/* DLF */
			-0.5, 0.0, -phi,
			-phi, 0.5, 0.0,
			0.0, phi, -0.5,
			/* AKH */
			-0.5, 0.0, phi,
			-phi, -0.5, 0.0,
			0.0, -phi, 0.5,
			/* BHJ */
			0.5, 0.0, phi,
			0.0, -phi, 0.5,
			phi, -0.5, 0.0,
			/* CJG */
			0.5, 0.0, -phi,
			phi, -0.5, 0.0,
			0.0, -phi, -0.5,
			/* DGK */
			-0.5, 0.0, -phi,
			0.0, -phi, -0.5,
			-phi, -0.5, 0.0,
		])), gl.STATIC_DRAW);

		gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ve);
		gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Uint8Array([
			0, 1, 2,
			3, 4, 5,
			
			6, 7, 8,
			9, 10, 11,
			
			12, 13, 14,
			15, 16, 17,
			
			18, 19, 20,
			21, 22, 23,
			
			24, 25, 26,
			27, 28, 29,
			
			30, 31, 32,
			33, 34, 35,
			
			36, 37, 38,
			39, 40, 41,
			42, 43, 44,
			45, 46, 47,
			
			48, 49, 50,
			51, 52, 53,
			54, 55, 56,
			57, 58, 59,
		]), gl.STATIC_DRAW);

		return [ vb, ve, ne ];
	};

	var prims = [];
	prims.push(primitive_tetrahedron());
	prims.push(primitive_cube());
	prims.push(primitive_octahedron());
	prims.push(primitive_icosahedron());
	var np = prims.length;

	var q = quat.create();
	var modelmat = mat4.create();
	var pmat = mat4.create();
	var normalmat = mat3.create();

	var viewportchanged = function(nw, nh) {
		mat4.perspective(pmat, fov, nw / nh, 0.1, 10000);
		gl.uniformMatrix4fv(upmat, false, new Float32Array(pmat));
	};

	var i, t, t0 = (new Date()).getTime();

	var spread = 10.0;
	var lx = 10.0;
	var ly = 0.0;
	var lz = 50.0;
	var w = 1.0;
	var tz = -30.0;
	var fov = .3;
	var rx = .003;
	var ry = .004;
	var rz = .005;
	
	add_menu_entry_range("rotX", {
		min: .0001,
		max: .1,
		init: rx,
		log: true,
		onchange: function(oldv, newv) {
			rx = newv;
		},
	});
	add_menu_entry_range("rotY", {
		min: .0001,
		max: .1,
		init: ry,
		log: true,
		onchange: function(oldv, newv) {
			ry = newv;
		},
	});
	add_menu_entry_range("rotZ", {
		min: .0001,
		max: .1,
		init: rz,
		log: true,
		onchange: function(oldv, newv) {
			rz = newv;
		},
	});

	add_menu_entry_range("lightX", {
		min: -20.0,
		max: 20.0,
		init: lx,
		onchange: function(oldv, newv) {
			lx = newv;
		},
	});
	add_menu_entry_range("lightY", {
		min: -20.0,
		max: 20.0,
		init: ly,
		onchange: function(oldv, newv) {
			ly = newv;
		},
	});
	add_menu_entry_range("lightZ", {
		min: -40.0,
		max: 100.0,
		init: lz,
		onchange: function(oldv, newv) {
			lz = newv;
		},
	});
	
	add_menu_entry_range("spread", {
		min: -20.0,
		max: 20.0,
		init: spread,
		onchange: function(oldv, newv) {
			spread = newv;
		},
	});
	
	add_menu_entry_range("w", {
		min: .1,
		max: 10.0,
		init: w,
		log: true,
		onchange: function(oldv, newv) {
			w = newv;
		},
	});
	
	add_menu_entry_range("fov", {
		min: .01,
		max: 3.141592,
		init: fov,
		log: true,
		onchange: function(oldv, newv) {
			fov = newv;
			$(canvas).trigger('viewportchange');
		},
	});
	
	add_menu_entry_range("tZ", {
		min: -100.0,
		max: 0.0,
		init: tz,
		onchange: function(oldv, newv) {
			tz = newv;
		},
	});

	var frame = function() {
		t = ((new Date()).getTime() - t0) / 1000.0;
		gl.uniform1f(ut, t);
		gl.uniform3f(ulpos, lx, ly, lz);
		gl.uniform1f(uw, w);

		for(i = 0; i < np; ++i) {
			mat4.fromRotationTranslation(modelmat, q, [ np === 1 ? 0.0 : -.5 * spread +  spread * i / (np - 1), 0.0, tz ]);
			mat3.normalFromMat4(normalmat, modelmat);
			gl.uniformMatrix4fv(umodelmat, false, new Float32Array(modelmat));
			gl.uniformMatrix3fv(unormalmat, false, new Float32Array(normalmat));
			
			gl.bindBuffer(gl.ARRAY_BUFFER, prims[i][0]);
			gl.vertexAttribPointer(aposition, 3, gl.FLOAT, false, 36, 0);
			gl.vertexAttribPointer(anormal, 3, gl.FLOAT, false, 36, 12);
			
			gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, prims[i][1]);
			gl.drawElements(gl.TRIANGLES, prims[i][2], gl.UNSIGNED_BYTE, 0);
		}

		quat.rotateX(q, q, rx);
		quat.rotateY(q, q, ry);
		quat.rotateZ(q, q, rz);
	};

	animate(gl, canvas, frame, viewportchanged);
});
</script>
</head>
<body>
<pre class='shader' id='vs'>
precision mediump float;

uniform mat4 modelmat;
uniform mat4 pmat;
uniform mat3 normalmat;
uniform float t;
uniform vec3 lpos;
uniform float w;

attribute vec3 position;
attribute vec3 normal;

varying float light;

void main() {
	vec4 wpos = modelmat * vec4(position, w);
	gl_Position = pmat * wpos;
	light = max(0.2, .9 * dot(normalize(lpos - wpos.xyz), normalize(normalmat * normal)));
}
</pre>
<pre class='shader' id='fs'>
precision mediump float;

varying float light;

void main() {
	gl_FragColor = vec4(
		vec3(1.0),
		light
	);
}
</pre>
</body>
</html>
